// Licensed to the Software Freedom Conservancy (SFC) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The SFC licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

package org.openqa.selenium.testing.drivers;

import static java.util.concurrent.TimeUnit.SECONDS;

import org.openqa.selenium.BuckBuild;
import org.openqa.selenium.net.NetworkUtils;
import org.openqa.selenium.net.PortProber;
import org.openqa.selenium.net.UrlChecker;
import org.openqa.selenium.os.CommandLine;
import org.openqa.selenium.testing.InProject;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
import java.util.logging.Logger;

public class OutOfProcessSeleniumServer {

  private static final Logger log = Logger.getLogger(OutOfProcessSeleniumServer.class.getName());

  private String baseUrl;
  private CommandLine command;
  @SuppressWarnings("unused")
  private boolean captureLogs = false;

  public void enableLogCapture() {
    captureLogs = true;
  }

  /**
   * Creates an out of process server with log capture enabled.
   *
   * @return The new server.
   */
  public OutOfProcessSeleniumServer start(String... extraFlags) throws IOException {
    log.info("Got a request to start a new selenium server");
    if (command != null) {
      log.info("Server already started");
      throw new RuntimeException("Server already started");
    }

    String serverJar = buildServerAndClasspath();

    int port = PortProber.findFreePort();
    String localAddress = new NetworkUtils().getPrivateLocalAddress();
    baseUrl = String.format("http://%s:%d", localAddress, port);

    List<String> cmdLine = new LinkedList<>();
    cmdLine.add("java");
    cmdLine.add("-jar");
    cmdLine.add(serverJar);
    cmdLine.add("-port");
    cmdLine.add(String.valueOf(port));
    cmdLine.addAll(Arrays.asList(extraFlags));
    command = new CommandLine(cmdLine.toArray(new String[cmdLine.size()]));

    if (Boolean.getBoolean("webdriver.development")) {
      command.copyOutputTo(System.err);
    }
    command.setWorkingDirectory(
      InProject.locate("Rakefile").getParent().toAbsolutePath().toString());
    log.info("Starting selenium server: " + command.toString());
    command.executeAsync();

    try {
      URL url = new URL(baseUrl + "/wd/hub/status");
      log.info("Waiting for server status on URL " + url);
      new UrlChecker().waitUntilAvailable(30, SECONDS, url);
      log.info("Server is ready");
    } catch (UrlChecker.TimeoutException e) {
      log.severe("Server failed to start: " + e.getMessage());
      command.destroy();
      log.severe(command.getStdOut());
      command = null;
      throw new RuntimeException(e);
    } catch (MalformedURLException e) {
      throw new RuntimeException(e);
    }

    Runtime.getRuntime().addShutdownHook(new Thread(this::stop));

    return this;
  }

  public void stop() {
    if (command == null) {
      return;
    }
    log.info("Stopping selenium server");
    command.destroy();
    log.info("Selenium server stopped");
    command = null;
  }

  private String buildServerAndClasspath() throws IOException {
    Path serverJar = new BuckBuild().of("//java/server/src/org/openqa/grid/selenium:selenium").go();
    return serverJar.toAbsolutePath().toString();
  }

  public URL getWebDriverUrl() {
    try {
      return new URL(baseUrl + "/wd/hub");
    } catch (MalformedURLException e) {
      throw new RuntimeException(e);
    }
  }
}
